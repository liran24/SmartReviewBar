# Smart Sticky Reviewer

A Wix App backend and widgets for displaying product reviews in a sticky bar format. Built with Clean Architecture principles and .NET 8.

## Features

- **Sticky Review Bar**: Display product ratings prominently on your site
- **Multiple Review Providers**: Support for Judge.me and Manual reviews
- **Fallback System**: Graceful degradation when primary provider fails
- **Plan-Based Features**: Free, Pro, and Premium subscription tiers
- **Admin Dashboard**: Configure all settings through an intuitive UI
- **Extensible Design**: Easy to add new review providers

## Tech Stack

### Backend
- .NET 8
- ASP.NET Core Web API
- MongoDB Atlas (Free Tier M0)
- MongoDB.Driver
- xUnit + FluentAssertions + Moq

### Frontend Widgets
- Vanilla HTML, CSS, JavaScript
- No external dependencies

## Solution Structure

```
SmartStickyReviewer/
├── src/
│   ├── SmartStickyReviewer.Domain/         # Core business entities and interfaces
│   ├── SmartStickyReviewer.Application/    # Use cases and business logic
│   ├── SmartStickyReviewer.Infrastructure/ # MongoDB, providers, policies
│   └── SmartStickyReviewer.Api/            # ASP.NET Core Web API (DI Root)
├── tests/
│   └── SmartStickyReviewer.Tests/          # Unit tests
├── widgets/
│   ├── admin-widget/                       # Admin configuration dashboard
│   └── site-widget/                        # Frontend display widget
└── SmartStickyReviewer.sln
```

## Getting Started

### Prerequisites

- .NET 8 SDK
- MongoDB Atlas account (or local MongoDB)

### Configuration

1. Update `appsettings.json` with your MongoDB connection string:

```json
{
  "MongoDB": {
    "ConnectionString": "mongodb+srv://<username>:<password>@<cluster>.mongodb.net/",
    "DatabaseName": "SmartStickyReviewer"
  }
}
```

### Running the API

```bash
cd src/SmartStickyReviewer.Api
dotnet run
```

The API will be available at `http://localhost:5000` (or the configured port).

### Running Tests

```bash
dotnet test
```

## Deployment (Tailway/Railway)

This application is configured for deployment on Tailway, Railway, and similar PaaS platforms.

### Using Docker (Recommended)

The included `Dockerfile` provides a multi-stage build:

```bash
# Build the image
docker build -t smart-sticky-reviewer .

# Run locally (testing)
docker run -p 8080:8080 \
  -e MongoDB__ConnectionString="your-mongodb-connection-string" \
  -e MongoDB__DatabaseName="SmartStickyReviewer" \
  smart-sticky-reviewer
```

### Using Nixpacks

The `nixpacks.toml` configuration enables automatic builds on platforms that support Nixpacks.

### Environment Variables

Configure these environment variables in your deployment platform:

| Variable | Description | Required |
|----------|-------------|----------|
| `PORT` | The port the application listens on (auto-set by platform) | Auto |
| `MongoDB__ConnectionString` | MongoDB Atlas connection string | Yes |
| `MongoDB__DatabaseName` | Database name (default: SmartStickyReviewer) | No |
| `ASPNETCORE_ENVIRONMENT` | Environment (Production/Development) | No |

### Tailway Deployment Steps

1. Connect your repository to Tailway
2. Set the environment variables in Tailway dashboard
3. Deploy - Tailway will automatically detect the Dockerfile or use Nixpacks
4. The application will start on the assigned PORT

### Using the Widgets

#### Admin Widget
Open `widgets/admin-widget/index.html` in a browser to access the configuration dashboard.

#### Site Widget

Include the embed script on your website:

```html
<script>
  window.SmartStickyReviewerConfig = {
    siteId: 'your-site-id',
    productId: 'your-product-id',
    apiUrl: 'https://your-api-domain.com/api'
  };
</script>
<script src="https://your-api-domain.com/widgets/site-widget/embed.js" async></script>
```

## Wix Setup (step-by-step)

The project ships two “Wix-side” pieces:

1. The **Admin Dashboard** (a static HTML page) where you create/update your site configuration and optional manual reviews.
2. The **Site Widget** (an embeddable script) that you inject into your Wix store so it can call your API and display the sticky review bar.

### 1) Deploy the API (Railway/Tailway)

1. Deploy this repo to Railway/Tailway (Dockerfile is recommended).
2. Set environment variables:
   - `MongoDB__ConnectionString`
   - `MongoDB__DatabaseName` (optional)
3. After deploy, copy your **public base URL**:
   - Example: `https://your-service.up.railway.app`
4. Sanity-check the API is up:
   - Open `https://YOUR_DOMAIN/swagger` in a browser (Swagger UI should load).

### 2) Decide your `siteId` and `productId` strategy (important)

This system treats `siteId` and `productId` as **string keys**. They do not get auto-generated by Wix in this repo.

1. Pick a stable `siteId` for your Wix store (any stable string is fine):
   - Examples: `my-wix-store`, `mybrand.com`
2. Pick a stable `productId` for each product page:
   - Recommended “no-Wix-API” option: use the **product page URL slug** (derive it from the URL).
   - Alternative: use the Wix Stores product internal ID (requires Velo code to read it).

Whatever you pick, it must match:
- What you embed on the Wix product page (`productId`)
- What you save in the Admin Dashboard when creating manual reviews (`productId`)

### 3) Open the Admin Dashboard and create your site configuration

When deployed, the Admin Dashboard is served by the API as a static file:

1. Open:
   - `https://YOUR_DOMAIN/widgets/admin-widget/index.html`
2. Enter your chosen **Site ID**.
3. Click **Save Configuration**.
4. (Optional) Configure:
   - Plan / provider
   - Styling (colors, position, font size)
   - Fallback settings
5. (Optional) Add manual fallback data per product:
   - Enter **Product ID** (must match what Wix will send)
   - Enter rating / count / display text
   - Click **Save Manual Review**

If you host the Admin Dashboard somewhere else (not on the same domain as the API), open it with an API override:

1. Open:
   - `.../index.html?apiBaseUrl=https://YOUR_DOMAIN/api`

### 4) Add the Site Widget to Wix (quick “works everywhere” install)

This is the simplest setup: it uses a fixed `siteId` and a fixed `productId` (good for testing).

1. In Wix, open your site dashboard → **Settings** → **Advanced** → **Custom Code**
2. Click **+ Add Custom Code**
3. Paste the following:

```html
<script>
  window.SmartStickyReviewerConfig = {
    siteId: "my-wix-store",
    productId: "test-product",
    apiUrl: "https://YOUR_DOMAIN/api"
  };
</script>
<script src="https://YOUR_DOMAIN/widgets/site-widget/embed.js" async></script>
```

4. Apply to:
   - **All pages** (for a quick test), or
   - Only your **Product Page** (recommended once working)
5. Choose placement:
   - “Body - end” is usually safest for third-party widgets
6. Publish your Wix site.

### 5) Make `productId` dynamic per product page (recommended)

To show the correct review bar per product, you must set a different `productId` on each product page.
The easiest method (without relying on Wix Stores APIs) is to derive `productId` from the URL.

1. Enable Velo in Wix Editor:
   - **Dev Mode (Velo)** → turn it on
2. Open your **Product Page** code panel.
3. Add code that sets the config *before* the widget script loads.

Approach A (recommended): **use the URL slug as `productId`**

```js
import wixLocation from 'wix-location';

$w.onReady(function () {
  const siteId = "my-wix-store"; // keep this stable

  // Use last URL segment as productId (slug)
  const path = wixLocation.path || [];
  const productId = path.length ? path[path.length - 1] : "unknown-product";

  window.SmartStickyReviewerConfig = {
    siteId,
    productId,
    apiUrl: "https://YOUR_DOMAIN/api"
  };

  const script = document.createElement('script');
  script.src = "https://YOUR_DOMAIN/widgets/site-widget/embed.js";
  script.async = true;
  document.body.appendChild(script);
});
```

Now, when you save manual reviews in the Admin Dashboard, use the **same slug** value as `productId`.

### 6) Verify it’s working

1. Open a product page on your live Wix site.
2. The sticky bar should appear within a second (after the API call).
3. If it doesn’t:
   - Open DevTools → Console (look for “Smart Sticky Reviewer” logs)
   - Check the API call:
     - `GET https://YOUR_DOMAIN/api/reviews?siteId=...&productId=...`

### 7) Common Wix-side pitfalls

1. **Wrong `apiUrl`**
   - It must end in `/api` (example: `https://YOUR_DOMAIN/api`).
2. **Mismatch between `productId` in Wix and Admin Dashboard**
   - If they don’t match exactly, manual fallback won’t be found for that product.
3. **Script added to the wrong pages**
   - If you only want it on product pages, add the custom code only to product pages.
4. **Preview vs Published**
   - Wix preview mode and published mode can differ; always test on the published site URL.

## API Endpoints

### Configuration

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/configuration/{siteId}` | Get site configuration |
| POST | `/api/configuration` | Save site configuration |
| GET | `/api/configuration/plans` | Get available plans |
| GET | `/api/configuration/providers` | Get available providers |

### Reviews

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/reviews?siteId=X&productId=Y` | Get review for product |
| POST | `/api/reviews/manual` | Save manual review |

### Health

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/health` | Health check |

## Subscription Plans

| Feature | Free | Pro | Premium |
|---------|------|-----|---------|
| Basic Review Display | ✓ | ✓ | ✓ |
| Multiple Review Providers | ✗ | ✓ | ✓ |
| Manual Fallback Text | ✗ | ✓ | ✓ |
| Email Notifications | ✗ | ✗ | ✓ |
| Advanced Styling | ✗ | ✗ | ✓ |

## Adding a New Review Provider

1. Create a new class implementing `IReviewProvider` in Infrastructure:

```csharp
public sealed class MyCustomProvider : IReviewProvider
{
    public ReviewProviderType ProviderType => ReviewProviderType.Custom;
    public string ProviderName => "My Custom Provider";

    public bool CanHandle(ReviewContext context) => true;

    public async Task<ReviewResult> GetReviewAsync(
        ReviewContext context,
        CancellationToken cancellationToken = default)
    {
        // Implement your logic
        return ReviewResult.Successful(4.5m, 100, "Great!", ProviderName);
    }
}
```

2. Add the new provider type to the `ReviewProviderType` enum in Domain.

3. Register the provider in `Program.cs`:

```csharp
builder.Services.AddScoped<MyCustomProvider>();

builder.Services.AddScoped<IEnumerable<IReviewProvider>>(sp =>
{
    return new List<IReviewProvider>
    {
        sp.GetRequiredService<JudgeMeReviewProvider>(),
        sp.GetRequiredService<ManualReviewProvider>(),
        sp.GetRequiredService<MyCustomProvider>() // Add here
    };
});
```

## Adding a New Paid Feature

1. Add the feature to the `Feature` enum in Domain:

```csharp
public enum Feature
{
    MultipleReviewProviders,
    ManualFallbackText,
    EmailNotificationOnFailure,
    AdvancedStyling,
    MyNewFeature  // Add here
}
```

2. Map the feature to a plan in `PlanBasedFeaturePolicy`:

```csharp
private static readonly Dictionary<Feature, Plan> FeaturePlanMapping = new()
{
    { Feature.MultipleReviewProviders, Plan.Pro },
    { Feature.ManualFallbackText, Plan.Pro },
    { Feature.EmailNotificationOnFailure, Plan.Premium },
    { Feature.AdvancedStyling, Plan.Premium },
    { Feature.MyNewFeature, Plan.Pro }  // Add here
};
```

3. Use the feature in your business logic:

```csharp
if (_featurePolicy.IsFeatureEnabled(Feature.MyNewFeature, config.Plan))
{
    // Feature is enabled
}
```

## Architecture

See [ARCHITECTURE.md](ARCHITECTURE.md) for detailed architecture documentation.

## License

MIT
